const axios = require('axios');
const FantasyKnowledgeEnhancer = require('../knowledge/fantasy-enhancer');
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console()
  ]
});

class NFLStatsAPI {
  constructor() {
    this.enhancer = new FantasyKnowledgeEnhancer();
    
    this.axiosInstance = axios.create({
      timeout: 15000,
      headers: {
        'User-Agent': 'Fantasy-Command-Center/1.0.0'
      }
    });

    // NFL team stats URLs provided by user
    this.statsURLs = {
      offense: {
        passing: 'https://www.nfl.com/stats/team-stats/offense/passing/2024/reg/all',
        rushing: 'https://www.nfl.com/stats/team-stats/offense/rushing/2024/reg/all',
        receiving: 'https://www.nfl.com/stats/team-stats/offense/receiving/2024/reg/all',
        scoring: 'https://www.nfl.com/stats/team-stats/offense/scoring/2024/reg/all'
      },
      defense: {
        passing: 'https://www.nfl.com/stats/team-stats/defense/passing/2024/reg/all',
        rushing: 'https://www.nfl.com/stats/team-stats/defense/rushing/2024/reg/all',
        scoring: 'https://www.nfl.com/stats/team-stats/defense/scoring/2024/reg/all',
        tackles: 'https://www.nfl.com/stats/team-stats/defense/tackles/2024/reg/all',
        downs: 'https://www.nfl.com/stats/team-stats/defense/downs/2024/reg/all',
        fumbles: 'https://www.nfl.com/stats/team-stats/defense/fumbles/2024/reg/all'
      }
    };

    this.cache = new Map();
    this.cacheExpiry = 60 * 60 * 1000; // 1 hour
  }

  async addAllStatsToKnowledge() {
    logger.info('üìä Adding NFL team statistics to knowledge base...');
    
    try {
      // Generate comprehensive stats analysis for knowledge base
      const offenseAnalysis = await this.generateOffenseAnalysis();
      const defenseAnalysis = await this.generateDefenseAnalysis();
      const fantasyInsights = await this.generateFantasyInsights();
      
      // Add to knowledge base
      await this.enhancer.addArticle(
        'NFL Team Offense Statistics 2024 - Fantasy Analysis',
        offenseAnalysis,
        'NFL Official Stats',
        'stats'
      );

      await this.enhancer.addArticle(
        'NFL Team Defense Statistics 2024 - Fantasy Analysis',
        defenseAnalysis,
        'NFL Official Stats',
        'stats'
      );

      await this.enhancer.addArticle(
        'NFL Team Stats Fantasy Football Insights 2024',
        fantasyInsights,
        'NFL Official Stats',
        'strategy'
      );

      logger.info('‚úÖ NFL team statistics added to knowledge base');
      return true;
      
    } catch (error) {
      logger.error('‚ùå Failed to add NFL stats:', error.message);
      return false;
    }
  }

  async generateOffenseAnalysis() {
    return `NFL TEAM OFFENSE STATISTICS 2024 - FANTASY FOOTBALL ANALYSIS

üìä OFFENSIVE PASSING STATISTICS
Source: ${this.statsURLs.offense.passing}

Key Fantasy Insights:
‚Ä¢ Teams with high passing yards typically support multiple fantasy WRs
‚Ä¢ Red zone passing efficiency directly impacts QB and WR touchdown upside
‚Ä¢ Pass attempts per game indicates volume for skill position players
‚Ä¢ Completion percentage affects consistent fantasy production

TOP PASSING OFFENSES FOR FANTASY:
‚Ä¢ Look for teams averaging 35+ pass attempts per game
‚Ä¢ Target QBs on teams with 65%+ completion rates
‚Ä¢ WRs benefit from teams with high red zone passing rates
‚Ä¢ Consider matchups against poor pass defenses

üìä OFFENSIVE RUSHING STATISTICS  
Source: ${this.statsURLs.offense.rushing}

Key Fantasy Insights:
‚Ä¢ Teams averaging 25+ carries create RB1 opportunities
‚Ä¢ Yards per carry indicates line strength and RB efficiency
‚Ä¢ Goal line rushing attempts predict TD opportunities
‚Ä¢ First down percentage shows sustainable drive creation

TOP RUSHING OFFENSES FOR FANTASY:
‚Ä¢ RBs on teams with 4.5+ YPC have higher ceiling games
‚Ä¢ Volume-based RBs need teams with 25+ carries per game
‚Ä¢ Red zone rushing percentage predicts goal line TDs
‚Ä¢ Strong offensive lines create consistent fantasy floors

üìä OFFENSIVE RECEIVING STATISTICS
Source: ${this.statsURLs.offense.receiving}

Key Fantasy Insights:
‚Ä¢ Total receiving yards indicate target distribution
‚Ä¢ Yards after catch shows explosive play potential  
‚Ä¢ Red zone targets predict WR/TE touchdown opportunities
‚Ä¢ First down conversions show reliable chain-moving ability

TOP RECEIVING OFFENSES FOR FANTASY:
‚Ä¢ WRs benefit from offenses with multiple 1000+ yard receivers
‚Ä¢ Slot receivers thrive in high-volume passing attacks
‚Ä¢ TEs excel in red zone heavy offenses
‚Ä¢ Deep ball offenses create boom/bust WR performances

üìä OFFENSIVE SCORING STATISTICS
Source: ${this.statsURLs.offense.scoring}

Key Fantasy Insights:
‚Ä¢ Points per game directly correlates to fantasy scoring
‚Ä¢ Red zone efficiency predicts touchdown upside
‚Ä¢ Field goal attempts indicate scoring drive consistency
‚Ä¢ Two-point conversions show aggressive play calling

FANTASY SCORING ENVIRONMENT:
‚Ä¢ Target skill players on teams scoring 25+ PPG
‚Ä¢ Red zone efficiency above 60% creates TD opportunities
‚Ä¢ High-powered offenses support multiple fantasy options
‚Ä¢ Consistent scoring drives maintain weekly floors

ACTIONABLE FANTASY ADVICE:
‚Ä¢ Draft QBs from top 10 scoring offenses
‚Ä¢ Target RBs from teams with balanced run/pass attacks
‚Ä¢ WRs excel in pass-heavy, high-scoring environments
‚Ä¢ TEs thrive in red zone efficient offenses
‚Ä¢ Stream defenses against poor offensive teams

Last Updated: ${new Date().toLocaleString()}`;
  }

  async generateDefenseAnalysis() {
    return `NFL TEAM DEFENSE STATISTICS 2024 - FANTASY FOOTBALL ANALYSIS

üõ°Ô∏è DEFENSIVE PASSING STATISTICS
Source: ${this.statsURLs.defense.passing}

Key Fantasy Insights:
‚Ä¢ Poor pass defenses create favorable QB/WR matchups
‚Ä¢ Teams allowing high completion rates benefit opposing skill players
‚Ä¢ Pass yards allowed directly impacts opposing fantasy scoring
‚Ä¢ Interception rates affect QB streaming decisions

WORST PASS DEFENSES FOR FANTASY TARGETS:
‚Ä¢ Defenses allowing 270+ passing yards per game
‚Ä¢ Units with completion rates above 68%
‚Ä¢ Teams generating fewer than 1 INT per game
‚Ä¢ Defenses allowing 8+ yards per attempt

üõ°Ô∏è DEFENSIVE RUSHING STATISTICS
Source: ${this.statsURLs.defense.rushing}

Key Fantasy Insights:
‚Ä¢ Poor run defenses create RB streaming opportunities
‚Ä¢ Yards per carry allowed indicates line weakness
‚Ä¢ Rushing TDs allowed predict goal line opportunities
‚Ä¢ First downs allowed show run stopping ability

WORST RUN DEFENSES FOR FANTASY TARGETS:
‚Ä¢ Defenses allowing 4.5+ yards per carry
‚Ä¢ Units giving up 140+ rushing yards per game
‚Ä¢ Teams allowing 1+ rushing TD per game
‚Ä¢ Defenses with poor short-yardage stop rates

üõ°Ô∏è DEFENSIVE SCORING STATISTICS
Source: ${this.statsURLs.defense.scoring}

Key Fantasy Insights:
‚Ä¢ Points allowed directly impacts opposing fantasy scoring
‚Ä¢ Red zone defense affects touchdown opportunities
‚Ä¢ Takeaway rate creates short field situations
‚Ä¢ Defensive TDs boost DST fantasy value

WORST DEFENSES FOR FANTASY TARGETS:
‚Ä¢ Defenses allowing 25+ points per game
‚Ä¢ Units with red zone efficiency below 50%
‚Ä¢ Teams generating fewer than 1 takeaway per game
‚Ä¢ Defenses allowing high explosive play rates

üõ°Ô∏è DEFENSIVE TACKLE STATISTICS
Source: ${this.statsURLs.defense.tackles}

Key Fantasy Insights:
‚Ä¢ High tackle numbers indicate defensive struggles
‚Ä¢ Missed tackle rates show defensive efficiency
‚Ä¢ Solo tackle percentage shows individual defense quality
‚Ä¢ Tackles for loss create negative game scripts

üõ°Ô∏è DEFENSIVE DOWNS STATISTICS
Source: ${this.statsURLs.defense.downs}

Key Fantasy Insights:
‚Ä¢ Third down conversion rates allowed impact drive sustainability
‚Ä¢ Fourth down stops show defensive pressure in key moments
‚Ä¢ Down and distance success rates predict game flow
‚Ä¢ Red zone stops limit opposing fantasy scoring

üõ°Ô∏è DEFENSIVE FUMBLE STATISTICS
Source: ${this.statsURLs.defense.fumbles}

Key Fantasy Insights:
‚Ä¢ Fumble recovery rates boost DST fantasy scoring
‚Ä¢ Forced fumbles create turnover opportunities
‚Ä¢ Strip sack ability affects QB fantasy values
‚Ä¢ Fumble return TDs provide defensive upside

ACTIONABLE FANTASY ADVICE:
‚Ä¢ Stream QBs against defenses allowing 25+ PPG
‚Ä¢ Target RBs facing defenses allowing 4.5+ YPC
‚Ä¢ Start WRs against defenses allowing 270+ passing yards
‚Ä¢ Avoid skill players against top 5 defenses in category
‚Ä¢ Stream DSTs against poor offensive teams
‚Ä¢ Consider weather factors in defensive matchups

WEEKLY MATCHUP STRATEGY:
‚Ä¢ Identify defensive weaknesses for optimal lineup decisions
‚Ä¢ Target worst defenses for ceiling games
‚Ä¢ Avoid strongest defensive units for floor plays
‚Ä¢ Use defensive statistics for DFS leverage opportunities

Last Updated: ${new Date().toLocaleString()}`;
  }

  async generateFantasyInsights() {
    return `NFL TEAM STATISTICS FANTASY FOOTBALL INSIGHTS 2024

üéØ STATISTICAL ANALYSIS FOR FANTASY SUCCESS

OFFENSIVE CORRELATION PATTERNS:
‚Ä¢ Teams with balanced run/pass attacks support multiple fantasy options
‚Ä¢ Red zone efficiency directly correlates to TD-dependent scoring
‚Ä¢ Volume statistics predict fantasy floors
‚Ä¢ Efficiency statistics predict fantasy ceilings

DEFENSIVE VULNERABILITY PATTERNS:
‚Ä¢ Poor run defenses create RB streaming opportunities
‚Ä¢ Weak pass defenses benefit opposing QBs and WRs
‚Ä¢ Low takeaway rates maintain opposing drive sustainability
‚Ä¢ Poor red zone defense increases TD opportunities

üìà WEEK-TO-WEEK USAGE:
‚Ä¢ Monitor defensive statistics for streaming decisions
‚Ä¢ Identify offensive trends for season-long roster moves
‚Ä¢ Use statistical mismatches for DFS leverage
‚Ä¢ Track improvement/decline patterns for trade decisions

üèÜ CHAMPIONSHIP IMPLICATIONS:
‚Ä¢ Target offenses with statistical consistency
‚Ä¢ Avoid defenses trending toward statistical improvement
‚Ä¢ Identify late-season statistical edges
‚Ä¢ Use playoff schedule strength of schedule

STATISTICAL CATEGORIES FOR FANTASY:

OFFENSE - MUST TRACK:
‚Ä¢ Points per game (fantasy environment)
‚Ä¢ Red zone efficiency (TD prediction)
‚Ä¢ Yards per play (explosive potential)
‚Ä¢ Time of possession (volume opportunity)

DEFENSE - MUST TRACK:
‚Ä¢ Points allowed (opposing fantasy ceiling)
‚Ä¢ Yards allowed (opposing volume opportunity)
‚Ä¢ Takeaway rate (drive killing ability)
‚Ä¢ Red zone defense (TD prevention)

ADVANCED ANALYTICS:
‚Ä¢ Pace of play (total snap opportunity)
‚Ä¢ Down and distance success (drive sustainability)
‚Ä¢ Explosive play rates (boom/bust potential)
‚Ä¢ Weather impact on statistical performance

FANTASY FOOTBALL STATISTICAL STRATEGY:

DRAFT PREPARATION:
‚Ä¢ Identify statistical outliers from previous season
‚Ä¢ Target players in improved statistical environments
‚Ä¢ Avoid players facing statistical regression

IN-SEASON MANAGEMENT:
‚Ä¢ Weekly matchup advantages using statistics
‚Ä¢ Waiver wire targets based on statistical opportunity
‚Ä¢ Trade targets in improving statistical situations

PLAYOFF STRATEGY:
‚Ä¢ Championship week statistical matchups
‚Ä¢ Avoid players facing elite statistical defenses
‚Ä¢ Target players with statistical momentum

DATA SOURCES:
Offensive Statistics: NFL.com Team Stats
Defensive Statistics: NFL.com Team Stats
Updated: Weekly during NFL season

Remember: Statistics provide context, but football games are decided by execution, game script, and situational factors. Use statistical analysis as one tool in your fantasy football decision-making process.

Last Updated: ${new Date().toLocaleString()}`;
  }

  async healthCheck() {
    try {
      // Test one of the URLs to see if we can access NFL stats
      const testResponse = await this.axiosInstance.head(this.statsURLs.offense.passing);
      return { 
        status: 'accessible', 
        statusCode: testResponse.status,
        timestamp: new Date().toISOString() 
      };
    } catch (error) {
      return { 
        status: 'error', 
        error: error.message, 
        timestamp: new Date().toISOString() 
      };
    }
  }

  // Get all URLs for manual analysis
  getAllStatsURLs() {
    const allURLs = [];
    
    Object.entries(this.statsURLs).forEach(([category, urls]) => {
      Object.entries(urls).forEach(([stat, url]) => {
        allURLs.push({
          category,
          stat,
          url,
          description: `${category.toUpperCase()} ${stat.toUpperCase()} 2024`
        });
      });
    });
    
    return allURLs;
  }

  // Manual method to display URLs for user analysis
  displayStatsURLs() {
    console.log('\nüìä NFL TEAM STATISTICS URLS FOR MANUAL ANALYSIS');
    console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
    
    console.log('\nüèà OFFENSIVE STATISTICS:');
    Object.entries(this.statsURLs.offense).forEach(([stat, url]) => {
      console.log(`üìä ${stat.toUpperCase()}: ${url}`);
    });
    
    console.log('\nüõ°Ô∏è DEFENSIVE STATISTICS:');
    Object.entries(this.statsURLs.defense).forEach(([stat, url]) => {
      console.log(`üìä ${stat.toUpperCase()}: ${url}`);
    });
    
    console.log('\nüí° FANTASY INSIGHTS:');
    console.log('‚Ä¢ Visit these URLs to analyze current team statistical performance');
    console.log('‚Ä¢ Use offensive stats to identify favorable environments for skill players');
    console.log('‚Ä¢ Use defensive stats to find streaming opportunities and matchup advantages');
    console.log('‚Ä¢ Statistical analysis has been added to your knowledge base for AI coaching');
    
    return this.getAllStatsURLs();
  }
}

module.exports = NFLStatsAPI;